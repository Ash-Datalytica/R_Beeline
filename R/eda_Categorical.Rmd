---
title: "Работа с категорийными параметрами"
author: "Alexey Shovkun"
date: "8 октября 2015 г."
output: html_document
---

```{r init, echo=FALSE, message=FALSE}
#install.packages ("data.table")
#install.packages ("Hmisc")
#install.packages ("mice")
#install.packages ("AppliedPredictiveModelling") # недоступен для R 3.0.2
#install.packages ("mice")
#install.packages ("RANN")
require (data.table)
require(caret) #dummyVars, featurePlot
#require(AppliedPredictiveModeling) #transparentTheme
require(Hmisc) #cut2
require(mice)
require (ggplot2)
require(gridExtra)
require (dplyr)

#require(parallel) #detectCores()
#require(doSNOW)

eval(parse('common.R',encoding = "UTF-8"))

#nCores <- detectCores()
##nCores <-6
#cl<-makeCluster(nCores) # Assign number of cores to use
#registerDoSNOW(cl) # Register the cores.

```

## Загрузка данных

За основу берем полученные ранее файлы *_ConstMedian.rds и *_ConstMedianRange.rds..

```{r loadData, echo=FALSE}
dfTrainCM <- readRDS ("../data/train_ConstMedian.rds")
dfTrainCMNR <- readRDS ("../data/train_ConstMedianRange.rds")
dfTrainCMYJR <- readRDS ("../data/train_ConstMedianYeoJohnsonRange.rds")
dfTrainCMSS <- readRDS ("../data/train_ConstMedianSelectedSure.rds")

colClasses <- as.character (sapply(dfTrainCMNR, class))
#table(colClasses)
colFactor <- colnames(dfTrainCMNR)[colClasses == "factor"]
colNumeric <- colnames(dfTrainCMNR)[colClasses == "numeric"]
colLogical <- colnames(dfTrainCMNR)[colClasses == "logical"]

```

## Замена пустых значений у категорийных параметров

Заменим значения "Не определено" (NA) на одно из имеющихся значений (категорий) у данного параметра. Вероятность нового значения пропорциональна его частоте в параметре.

```{r imputeCategorical, echo=FALSE}
dfNewFactorTrain <- replaceNACategorical(dfTrainCM[colFactor[1]], "Не определено")

# VM  = ValueMedian, Value - замена пустых строк на одно из значений
dfTrainVM <- dfTrainCM
dfTrainVM[colFactor] <- dfNewFactorTrain
saveRDS(dfTrainVM, "../data/train_ValueMedian.rds")

# VMNR  = ValueMedianRange, Value - замена пустых строк на одно из значений
dfTrainVMNR <- dfTrainCMNR
dfTrainVMNR[colFactor] <- dfNewFactorTrain
saveRDS(dfTrainVMNR, "../data/train_ValueMedianRange.rds")

# VMYJR  = ValueMedianRange, Value - замена пустых строк на одно из значений
dfTrainVMYJR <- dfTrainCMYJR
dfTrainVMYJR[colFactor] <- dfNewFactorTrain
saveRDS(dfTrainVMYJR, "../data/train_ValueMedianYeoJohnsonRange.rds")

# VMSS  = ValueMedianSelectedSure, Value - замена пустых строк на одно из значений
dfTrainVMSS <- dfTrainCMSS
dfTrainVMSS[colFactor] <- dfNewFactorTrain
saveRDS(dfTrainVMS, "../data/train_ValueMedianSelectedSure.rds")


```

## Сокращение различных значений у категорийных параметров

Способ 1, "Замена". У много-категорийных параметров заменить категорию на класс (номер возрастной группы), которая встречается у него чаще всего.

```{r substituteCategorical, echo=FALSE}

```


Способ 2, "Упаковка". У много-категорийных параметров заменить *упаковать* категории в группы по частоте встречания.

```{r packCategorical, echo=FALSE}
require (dplyr)
#importantFeatures1 включает в себя категорийные параметры с 10 или менее категориями
maxCategories <- 5 # свертываем параметры до этого числа категорий
data <- dfTrainVM
uniqueCount <- sapply(data, function(x){length(unique(x))})
colLongCat <- names(uniqueCount[colFactor][uniqueCount[colFactor] >= maxCategories])

dfTmp <- data[c(colLongCat[1],"y")]
View(dfTmp)
dfTmp1 <- dfTmp %>% group_by (x0,y) %>% summarize(count=n()) %>% #View
    top_n(1,count) %>% # оставляем только с макс. 
    group_by(x0) %>% filter(row_number() == 1) %>% View


```

